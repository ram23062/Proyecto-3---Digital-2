// Universidad del Valle de Guatemala
// BE3029 - Electronica Digital 2
// Oscar Ramírez - Youri Estrada
// Proyecto 3
// 04/11/2025 - 17/11/2025

//Librerías
#include <Arduino.h>
#include <stdint.h>
//#include <Adafruit_BME280.h>
//#include <Adafruit_BMP280.h>
#include <Adafruit_Sensor.h>
#include <Wire.h>
#include <Adafruit_NeoPixel.h>
#include <Temperature_LM75_Derived.h>

//Pines
#define NEO 32
#define NUMPIXELS 3
#define desmonte 18
#define guardado 19

//Sensor LM75
Generic_LM75 termo(0x48);

// Variables Globales
uint8_t tx_2_buf[16];
uint8_t rx2_buf[8];
float Temperatura;

//Neopixel
Adafruit_NeoPixel pixels(NUMPIXELS, NEO, NEO_GRB + NEO_KHZ800);
uint32_t amarillo;
uint32_t rojo;
uint32_t morado;
uint32_t naranja;
uint32_t verde;
#define DELAYVAL 500
//I2C
//Prototipo de función
void leerSensor(void);
void setAllPixelsColor(uint32_t color);

/*•︶°︶•︶°︶•︶°︶•︶°︶•︶°︶•︶°︶• SETUP °︶•︶°︶•︶°︶•︶°︶•︶°︶•︶°︶• */
void setup()
{
  Serial.begin(115200);
  Serial2.begin(115200);
  Wire.begin(21,22);
  Serial.println("\nEscaneando el bus I2C...");
  Serial.println("---------------------------");
  
  //Inicialización del sensor LM75
  


  pinMode(desmonte, INPUT_PULLUP);
  pinMode(guardado, INPUT_PULLUP);

  //Neopixel
  pixels.begin();
  //Configuración de colores
  amarillo = pixels.Color(255, 255, 0);
  rojo = pixels.Color(255, 0, 0);
  morado = pixels.Color(150, 0, 128);
  naranja = pixels.Color(255, 50, 0);
  verde = pixels.Color(0, 255, 0);
  pixels.clear();
  setAllPixelsColor(rojo);
}


/*•︶°︶•︶°︶•︶°︶•︶°︶•︶°︶• LOOP °︶•︶°︶•︶°︶•︶°︶•︶°︶•︶°︶• */
void loop()
{
  //En espera
  setAllPixelsColor(rojo);
  pixels.clear();
  
  
  if (Serial2.available()>0){ //Verifica si hay bytes disponibles de lo que se recibió
    char dato_recibido = Serial2.read(); //Lee el primer byte del comando recibido
    if (dato_recibido == '1'){
      //Indicador de recibido: Naranja
      setAllPixelsColor(naranja);
      Serial.println("\n--- Solicitud recibida por UART ---");
      delay(DELAYVAL*2);
      //Ejecutar la respuesta solicitada (Enviar info del sensor)
      leerSensor();
      //Construir el buffer
      int dato_enviado = sprintf((char*)tx_2_buf,"%.2f\n", Temperatura);
      //Dato enviado a la nucleo
      Serial2.write(tx_2_buf, dato_enviado);
      //Regresar 
      setAllPixelsColor(rojo);
    } else if (dato_recibido == '2'){
      //Indicador de enviado: amarillo
      setAllPixelsColor(amarillo);
      //Debug por serial para verificar
      Serial.print ("Enviado a Nucleo (UART2): ");
      delay(DELAYVAL*2); 
      //Volver al estado base (Rojo)
      setAllPixelsColor(rojo);
    } else if (dato_recibido == '3'){
      setAllPixelsColor(verde);
      Serial.println("Datos guardados en SD");
      delay(DELAYVAL*2);
      //Volver al estado base
      setAllPixelsColor(rojo);
    }else if (dato_recibido == '4'){
      setAllPixelsColor(morado);
      Serial.println("Tarjeta SD desmontada");
      delay(DELAYVAL*2);
      //Volver al estado base
      setAllPixelsColor(rojo);
    }
      else {
      Serial.print("Dato inválido: ");
      Serial.println(dato_recibido);
    }
  }
  
  
}

//Funciones auxiliares
void leerSensor(){
  Temperatura= termo.readTemperatureC();
}
void setAllPixelsColor(uint32_t color) {
    pixels.clear(); // Opcional, pero ayuda a asegurar que los colores anteriores se borren
    for(int i = 0; i < NUMPIXELS; i++) { 
        pixels.setPixelColor(i, color);
    }
    pixels.show(); 
}
